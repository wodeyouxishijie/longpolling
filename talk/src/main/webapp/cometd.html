<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
		<title>Talk In Time</title>
		<link href="css/bootstrap.min.css" media="all" rel="stylesheet" type="text/css">
		<link href="css/style.css" media="all" rel="stylesheet" type="text/css">
		<meta name="viewport" content="width=device-width, maximum-scale=1.0, initial-scale=1, user-scalable=no">
		<script type="text/javascript" src="js/jquery-1.8.1.min.js"></script>
	</head>
	 <style>
         @media screen and (min-width: 600px) {
              #talk-window {
                     height:600px;
              }
         }
         
         .file-input-wrapper{
			float: left;
			height: 33px;
			background:url('../images/photo.png');
			width: 33px;
			position:relative;
			margin-right:10px;
		}
		.file-input-div{
			text-align:center;
			padding-top:12px;
			font-size:15px;
			font-weight:800
		}
		.inputstyle{
		    width: 0px;
		    height: 0px;
		    cursor: pointer;
		    font-size: 1px;
		    outline: medium none;
		    position: absolute;
		    filter:alpha(opacity=0);
		    -moz-opacity:0;
		    opacity:0; 
		    left:0px;
		    top: 0px;
		}
    </style>
	<script>
		var versionId = 0;
		var max_rows = 20;
		var maxMessageId = 0;
		var uniqueId = 'testId';
		var appId = 100001;
		var typeId = 1;
		$(document).ready(function(){  
			polling();
			$('.JInputButton').bind('click',function() {
			  if($.trim($('#inputTextId').val()) == "") return;
			  sendMsg();
			  $('#inputTextId').focus();
			}); 
			$('#inputTextId').focus();
			$(document).keydown(function(event){
			     if(event.keyCode==13){
			    	 if($('#inputTextId').val() != "") {
			    		 $('.JInputButton').click();
			    	 }
			    	 return false;
			     }
			});
		});  
		
		function sendMsg() {
			$('#JInputButton').attr("disabled","disabled");
			 $.post("/send", 
					  {"_appId":appId,
						    "_typeId":typeId,
						    "_unqId":uniqueId,
						    "_message":""+$('#inputTextId').val(),
						    "timestamp":(new Date()).valueOf()},
					  function(data) {
						  if(!data.success) {
							  	if(data.message == "NOT_LOGIN") {
							  		window.location.href="/login.html";
							  	} else {
		                    		alert('发送失败！原因：'+data.message);
							  	}
		                   } else {
		                	   $('#inputTextId').val("");
		                   }
						  $('#JInputButton').attr("disabled","");
				  	  },
				  	  "json"
			  );
		}
		
		function getmaxId() {
			return versionId;
		}
		
		function getMessageId() {
			return maxMessageId;
		}
		
		function polling() {
			$.ajax({      
                type:"GET",      
                dataType:"json",      
                url:"/pull",
                data:{"_appId":appId,"_typeId":typeId,"_unqId":uniqueId,"vId":getmaxId(),"msgId":getMessageId(),"timestamp":(new Date()).valueOf()},
                timeout:35000,
                success:function(data,textStatus){
                    if(data.success){
                    	if(data.data && data.data.length > 0) {
	                    	for(i=data.data.length-1;i >=0 ;i-- ) {
	                    		var obj = $('<li class="'+(data.data[i].self==true?'current-user':'')+
	                    				'"> <img width="30" height="30" src="'+data.data[i].avatar
	                    				+'" /> <div class="bubble"> <a class="user-name" href="#">'+data.data[i].userNick
	                    				+'</a> <p class="message">'+data.data[i].msg+' </p> <p class="time"> <strong>今天 </strong>'
	                    				+data.data[i].timeStr+' </p> </div> </li>');
	    	      				obj.css("opacity","0");
	    	      				$('#content-ul').append(obj);
	    	      				obj.animate({opacity:1},800);
	    	      				var div = $("div[class='widget-content padded']");
	    		  				div.scrollTop($("div[class='widget-content padded']")[0].scrollHeight);
	    		  				if($("#content-ul").children().length > max_rows) {
	    		  					$($("#content-ul").children()[0]).remove();
	    		  					$($("#content-ul").children()[0]).remove();
	    		  				}
	                    	}	
	                    	maxMessageId = data.data[data.data.length-1].messageId;
	                    	versionId = data.data[data.data.length-1].id;
                    	}		
                    } else {
                    }   
                },      
                
	            error:function(XMLHttpRequest,textStatus,errorThrown){      
                     if(textStatus=="timeout"){      
                     }
	            },
	            complete:function () {
	            	polling();
	            }
            });      
		}
		
	</script>
	<body style="padding:0px;">
	<!-- container -->
		<div class="">
			 <div class="col-md-12">
				<div class="widget-container scrollable chat" id="talk-window">
				  <div class="heading">
					<i class="icon-comments"></i>聊天窗口<i class="icon-smile pull-right"></i>
				  </div>
				  <div class="widget-content padded">
					<ul id='content-ul'>
						<li>
							<img width="30" height="30" src="images/50x50/avatar-male.jpg">
							<div class="bubble">
							  <a class="user-name" href="#">ROOT</a>
							  <p class="message">
								扫描二维码，一起来瞎扯吧！！
							  </p>
							  <p class="time">
								<strong></strong>
							  </p>
							</div>
					    </li>
					</ul>
				  </div>
				  <div class="post-message">
					<div class="file-input-wrapper">
						<div class="file-input-div"></div>
						<input type="file" class="inputstyle" name="_upload_pic"/>
					</div>
					<div style="margin-left:43px;">
						<input class="form-control" id='inputTextId' width="100%"  placeholder="Write your message here..." type="text">
						<input type="submit" class='JInputButton'  value="Send">
					</div>
				  </div>
				</div>
			  </div>
		</div>
	</body>
</html>